<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <title>Admin page</title>
  <style>
      body {
          font-family: 'Inter', sans-serif;
      }
  </style>
</head>
<body class="bg-gray-50">
<div class="flex flex-col m-auto py-8" style="width: 80%;">
  <div class="flex justify-between">
    <h1 class="text-4xl font-bold text-gray-800 mb-6">Панель Администратора</h1>
    <div class="float-right mt-2 ms-2">
      <img src="https://i.pinimg.com/736x/07/01/1e/07011eccd1f3c45d149441de527aa693.jpg" height="80" width="80" alt="Лого" style="border: #888888 1px solid; border-radius: 3px;">
      <p>Котенок</p>
    </div>
  </div>

  <div class="flex flex-col">
    <h2 class="mt-6 text-2xl font-semibold text-gray-700">Категории</h2>
    <div class="flex justify-between gap-6 mt-4">
      <table class="border-collapse border border-gray-300 w-full h-auto bg-white shadow-sm rounded-lg overflow-hidden" id="categoryTable">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2 text-left text-gray-700">Id</th>
          <th class="border border-gray-300 px-4 py-2 text-left text-gray-700">Название</th>
          <th class="border border-gray-300 px-4 py-2 text-left text-gray-700">Действия</th>
        </tr>
        </thead>
        <tbody class="text-gray-600"></tbody>
      </table>
      <form class="flex flex-col w-full bg-white p-6 rounded-lg shadow-sm" id="categoryForm">
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-medium mb-2" for="categoryId">
            ID изменяемой категории
          </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" id="categoryId" type="number" placeholder="Введите ID категории если хотите изменить её">
        </div>
        <div class="mb-6">
          <label class="block text-gray-700 text-sm font-medium mb-2" for="categoryName">
            Название категории
          </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" id="categoryName" type="text" placeholder="Название категории">
        </div>
        <button class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-green-500" type="submit">
          Сохранить
        </button>
      </form>
    </div>

    <h2 class="mt-8 text-2xl font-semibold text-gray-700">Продукты</h2>
    <div class="flex justify-between gap-6 mt-4">
      <table class="border-collapse border border-gray-300 w-full h-auto bg-white shadow-sm rounded-lg overflow-hidden" id="productsTable">
        <thead class="bg-gray-100">
        <tr>
          <th class="border border-gray-300 px-4 py-2 text-left text-gray-700">Id</th>
          <th class="border border-gray-300 px-4 py-2 text-left text-gray-700">Название</th>
          <th class="border border-gray-300 px-4 py-2 text-left text-gray-700">Цена</th>
          <th class="border border-gray-300 px-4 py-2 text-left text-gray-700">Описание</th>
          <th class="border border-gray-300 px-4 py-2 text-left text-gray-700">ID категорий</th>
          <th class="border border-gray-300 px-4 py-2 text-left text-gray-700">Действия</th>
        </tr>
        </thead>
        <tbody class="text-gray-600"></tbody>
      </table>
      <form class="flex flex-col w-full bg-white p-6 rounded-lg shadow-sm" id="productForm">
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-medium mb-2" for="productId">
            ID изменяемого продукта
          </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" id="productId" type="number" placeholder="Введите ID продукта если хотите изменить его">
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-medium mb-2" for="productName">
            Название продукта
          </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" id="productName" type="text" placeholder="Название продукта">
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-medium mb-2" for="productPrice">
            Цена продукта
          </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" id="productPrice" type="number" placeholder="Цена продукта">
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-medium mb-2" for="productDescription">
            Описание продукта
          </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" id="productDescription" type="text" placeholder="Описание продукта">
        </div>
        <div class="mb-6">
          <label class="block text-gray-700 text-sm font-medium mb-2" for="productCategoryIds">
            ID категорий продукта
          </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" id="productCategoryIds" type="text" placeholder="ID категорий продукта через запятую (к примеру 42,13)">
        </div>
        <button class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-green-500" type="submit">
          Сохранить
        </button>
      </form>
    </div>
  </div>
</div>
<div class="flex flex-col py-8 m-auto" style="width: 80%;">
  <div class="flex flex-col gap-2 mt-4" style="width: 30%">
    <input id = "messageArea" type="text" size="30" class="border block">
    <input type="submit" value="Отправить" onclick=sendMessage() class="border block" style="height: 50px"><br>
    <div id="textArea"></div>
  </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script>
    function productDeleteClick(productId) {
        $.ajax({
            url: `/products/${productId}`,
            method: 'delete',
            success: () => {
                location.reload();
            },
        });
    }

    function categoryDeleteClick(categoryId) {
        $.ajax({
            url: `/categories/${categoryId}`,
            method: 'delete',
            success: () => {
                location.reload();
            },
        });
    }

    let products, categories;
    $.ajax({
        url: '/products',
        method: 'get',
        success: (data) => {
            products = data;
            let productsRowsHTML = '';
            for (const product of products) {
                productsRowsHTML += '<tr>'
                productsRowsHTML += `<td class="border border-gray-300 px-4 py-2">${product.id}</td>`;
                productsRowsHTML += `<td class="border border-gray-300 px-4 py-2">${product.name}</td>`;
                productsRowsHTML += `<td class="border border-gray-300 px-4 py-2">${product.price}</td>`;
                productsRowsHTML += `<td class="border border-gray-300 px-4 py-2">${product.description}</td>`;
                productsRowsHTML += `<td class="border border-gray-300 px-4 py-2 text-center">${product.categoryIds}</td>`;
                productsRowsHTML += `<td class="border border-gray-300 px-4 py-2">
                    <button class="del-product-btn bg-red-600 hover:bg-red-700 text-white font-medium text-sm mx-2 py-1 px-2 rounded focus:outline-none focus:ring-2 focus:ring-red-500" type="button" onclick="productDeleteClick(${product.id})">Удалить</button>
                  </td>`;
                productsRowsHTML += '</tr>';
            }
            $('#productsTable tbody').wrapInner(productsRowsHTML);
        }
    });
    $.ajax({
        url: '/categories',
        method: 'get',
        success: (data) => {
            categories = data;
            let categoriesRowsHTML = '';
            for (const category of categories) {
                categoriesRowsHTML += '<tr>'
                categoriesRowsHTML += `<td class="border border-gray-300 px-4 py-2">${category.id}</td>`;
                categoriesRowsHTML += `<td class="border border-gray-300 px-4 py-2">${category.name}</td>`;
                categoriesRowsHTML += `<td class="border border-gray-300 px-4 py-2">
                    <button class="del-product-btn bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-red-500 mx-auto block" type="button" onclick="categoryDeleteClick(${category.id})">Удалить</button>
                  </td>`;
                categoriesRowsHTML += '</tr>';
            }
            $('#categoryTable tbody').wrapInner(categoriesRowsHTML);
        }
    });

    $('#categoryForm').on('submit', (e) => {
        e.preventDefault();
        let categoryId, categoryName;
        categoryId = $('#categoryId').val();
        categoryName = $('#categoryName').val();

        if (categoryId) {
            $.ajax({
                url: `/categories/${categoryId}`,
                method: 'put',
                data: JSON.stringify({
                    name: categoryName,
                }),
                contentType: 'application/json',
                success: () => {
                    location.reload();
                }
            });
            return;
        }

        $.ajax({
            url: '/categories',
            method: 'post',
            data: JSON.stringify({
                name: categoryName,
            }),
            contentType: 'application/json',
            success: () => {
                location.reload();
            }
        });
    });

    $('#productForm').on('submit', (e) => {
        e.preventDefault();
        let productId, productName, productPrice, productDescription, productCategoryIds;
        productId = $('#productId').val();
        productName = $('#productName').val();
        productPrice = $('#productPrice').val();
        productDescription = $('#productDescription').val();
        productCategoryIds = $('#productCategoryIds').val().split(',').map((i) => parseInt(i, 10));

        if (productId) {
            $.ajax({
                url: `/products/${productId}`,
                method: 'put',
                data: JSON.stringify({
                    name: productName,
                    price: productPrice,
                    description: productDescription,
                    categoryIds: productCategoryIds,
                }),
                contentType: 'application/json',
                success: () => {
                    location.reload();
                }
            });
            return;
        }

        $.ajax({
            url: '/products',
            method: 'post',
            data: JSON.stringify({
                name: productName,
                price: productPrice,
                description: productDescription,
                categoryIds: productCategoryIds,
            }),
            contentType: 'application/json',
            success: () => {
                location.reload();
            }
        });
    });

</script>
<script>
    const connection = new WebSocket("ws://localhost:9000");

    // если соединение успешно установлено
    connection.onopen = (event) => {
        console.log("Connection opened");
    };

    // если возникла ошибка
    connection.onerror = (error) => {
        console.log(`WebSocket Error: ${error}`);
    };

    // если соединение закрыто
    connection.onclose = (event) => {
        console.log("Connection closed");
    };

    // получаем ответ сервера
    connection.onmessage = (event) => {
        const eventJson = JSON.parse(event.data);
        message = document.createElement('p');
        message.textContent = `${eventJson.sender === 'moderator' ? 'Вы' : 'Пользователь'}: ${eventJson.content}`;
        document.getElementById('textArea').append(message);
        console.log("Server response:", event.data);
    };

    function sendMessage() {
        text = document.getElementById('messageArea').value;
        if (text === "") {
            alert("Пожалуйста, введите непустую строку")
        } else {
            connection.send(JSON.stringify({sender: "moderator", content: text}));
            document.getElementById('messageArea').value = '';
        }
    }
</script>
</body>
</html>